#include<SoftwareSerial.h>

SoftwareSerial gps(7,6);
#include<LiquidCrystal.h>
LiquidCrystal lcd(13,12,11,10,9,8);
String data="";
String data1="";
int button=A0;
int buzzer=A1;
int buttonState = 0;  
int i=0,k=0;
int  gps_status=0;
float latitude=17.42574501150893;//17.42574501150893, 78.71303330804469
float logitude=78.71303330804469;                       
String Speed="";
String gpsString="";
char *test="$GPRMC";
int time=0;
void setup() 
{
pinMode(button,INPUT_PULLUP); 
pinMode(buzzer,OUTPUT);digitalWrite(buzzer,LOW); 
  Serial.begin(9600);
  lcd.begin(16,2);  
  lcd.print("VEHICLE ACCIDENT ");
  lcd.setCursor(0,1);
  lcd.print("ALERTING SYSTEM");
  delay(2000);
  lcd.clear();
  lcd.print("Initializing");
  lcd.setCursor(0,1);
  lcd.print("Please Wait...");
  delay(1000);
  lcd.clear();lcd.print("Waiting For GPS");
  lcd.setCursor(0,1);lcd.print("     Signal    ");
  delay(2000);
  gps.begin(9600);
get_gps();
 show_coordinate();
 // delay(2000);
  lcd.clear();
  lcd.print("GPS is Ready");
  delay(1000);
  lcd.setCursor(0,1);
  lcd.print("System Ready");delay(2000);
Serial.begin(9600);delay(1000); 
lcd.clear();lcd.print("READY TO USE.....");delay(2000);
}

void loop() 
{
 
get_gps();
show_coordinate();
String location=" http://maps.google.com/maps?&z=15&mrt=yp&t=k&q="+String(latitude,6)+"+"+String(logitude,6); 
int bval=digitalRead(button);
if(bval==LOW)
{
digitalWrite(buzzer,HIGH);  
lcd.clear();lcd.print("SENDING LOCATION");delay(1000);
Serial.println(location);delay(1000); 
digitalWrite(buzzer,LOW); 
}
}

void gpsEvent()
{
  gpsString="";
  while(1)
  {
   while (gps.available()>0)            //Serial incoming data from GPS
   {
    char inChar = (char)gps.read();
     gpsString+= inChar;                    //store incoming data from GPS to temparary string str[]
     i++;
    // Serial.print(inChar);
     if (i < 7)                      
     {
      if(gpsString[i-1] != test[i-1])         //check for right string
      {
        i=0;
        gpsString="";
      }
     }
    if(inChar=='\r')
    {
     if(i>60)
     {
       gps_status=1;
       break;
     }
     else
     {
       i=0;
     }
    }
  }
   if(gps_status)
    break;
  }
}
void get_gps()
{
  lcd.clear();
  lcd.print("Getting GPS Data");
  lcd.setCursor(0,1);
  lcd.print("Please Wait.....");
   gps_status=0;
   int x=0;
   while(gps_status==0)
   {
    gpsEvent();
    int str_lenth=i;
    coordinate2dec();
    i=0;x=0;
    str_lenth=0;
   }
}
void show_coordinate()
{
    lcd.clear();
    lcd.print("Lat:");
    lcd.print(latitude);
    lcd.setCursor(0,1);
    lcd.print("Log:");
    lcd.print(logitude);delay(1000);
  /*  Serial.print("Latitude:");
    Serial.println(latitude);
    Serial.print("Longitude:");
    Serial.println(logitude);
    Serial.print("Speed(in knots)=");
    Serial.println(Speed);
    delay(2000);
    lcd.clear();
   // lcd.print("Speed(Knots):");
    //lcd.setCursor(0,1);
    //lcd.print(Speed);*/
}
void coordinate2dec()
{
  String lat_degree="";
    for(i=19;i<=20;i++)         
      lat_degree+=gpsString[i];
     // Serial.println(lat_degree);
  String lat_minut="";
     for(i=21;i<=30;i++)         
      lat_minut+=gpsString[i];
      //Serial.println(lat_minut);
  String log_degree="";
    for(i=32;i<=34;i++)
      log_degree+=gpsString[i];
      //Serial.println(log_degree);
  String log_minut="";
    for(i=35;i<=44;i++)
      log_minut+=gpsString[i];
     // Serial.println(log_minut);
    
    Speed="";
    for(i=45;i<48;i++)          //extract longitude from string
      Speed+=gpsString[i];
      
     float minut= lat_minut.toFloat();
     minut=minut/60;
     float degree=lat_degree.toFloat();
     latitude=degree+minut;
    // Serial.println(latitude);
     
     minut= log_minut.toFloat();
     minut=minut/60;
     degree=log_degree.toFloat();
     logitude=degree+minut;
     //Serial.println(logitude);
}
void Send()
{ 
/*  lcd.clear();lcd.print("Sending Sms");
  lcd.setCursor(0,1);lcd.print("To");lcd.print(number);delay(1000);
   Serial.println("AT");delay(500);
   Serial.println("AT+CMGF=1");delay(500);
   
   Serial.print("AT+CMGS=");
   Serial.print('"');
   Serial.print(number);    //mobile no. for SMS alert
   Serial.println('"');delay(1000);
  
   Serial.print(data); Serial.print("  ");
   Serial.print("Latitude:");Serial.println(latitude,6);delay(500);
   Serial.print(" longitude:"); Serial.println(logitude,6); delay(500);
   Serial.print("http://maps.google.com/maps?&z=15&mrt=yp&t=k&q=");
   Serial.print(latitude,6);
   Serial.print("+");              //28.612953, 77.231545   //28.612953,77.2293563
   Serial.print(logitude,6);
   Serial.write(26);
   delay(2000);
   lcd.clear();lcd.print("Check u r INBOX");delay(1000);
   lcd.clear();lcd.print("Ready to use...");
  
*/
}